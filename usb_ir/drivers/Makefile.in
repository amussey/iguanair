

top_srcdir = @top_srcdir@
srcdir = @srcdir@
top_builddir = @top_builddir@
builddir = @builddir@

include ../Make.settings

ifdef DARWIN
MODULE_PREFIX = ig
endif

LIBUSB_10 = @LIBUSB_10@
LIBUSB_0 = @LIBUSB_0@

ifneq ($(LIBUSB_10),)
LIBUSB1DRIVER=$(MODULE_PREFIX)libusb.$(DYNMOD_EXT)
endif
ifneq ($(LIBUSB_0),)
LIBUSB0DRIVER=$(MODULE_PREFIX)libusbpre1.$(DYNMOD_EXT)
endif

DRIVERS=$(LIBUSB1DRIVER) $(LIBUSB0DRIVER)

LISTS=../list.o ../support.o

ifdef DARWIN
  LDFLAGS += -undefined dynamic_lookup
endif

all: $(DRIVERS)

$(LIBUSB1DRIVER): libusb.o $(LISTS) Makefile
	$(CC) $(CPPFLAGS) $(CFLAGS) $(DYNLIB_FLAGS) $(LDFLAGS) $< \
		$(LISTS) $(LIBUSB_10) -o $@

$(LIBUSB0DRIVER): libusbpre1.o $(LISTS) Makefile
	$(CC) $(CPPFLAGS) $(CFLAGS) $(DYNLIB_FLAGS) $(LDFLAGS) $< \
		$(LISTS) $(LIBUSB_0) -o $@

%.o: $(srcdir)/%.c Makefile $(top_srcdir)/iguanaIR.h
	$(CC) -c $(CPPFLAGS) $(CFLAGS) $< -o $@

.PHONY: install
install: all
	$(INSTALL) -d -m 755 $(DESTDIR)/$(libdir)/iguanaIR/;
	for f in $(DRIVERS); do \
	  $(INSTALL_DYNLIB) $$f $(DESTDIR)/$(libdir)/iguanaIR/$$f; \
	done

.PHONY: uninstall
uninstall: 
	for f in $(DRIVERS); do \
	  $(RM) $(DESTDIR)/$(libdir)/iguanaIR/$$f; \
	done

.PHONY: clean distclean
clean:
	$(RM) *~ *.o $(DRIVERS)
distclean: clean
	$(RM) Makefile

Makefile: ../config.status $(srcdir)/Makefile.in $(top_srcdir)/Make.settings.in
	cd .. && $(SHELL) ./config.status

