
top_srcdir = @top_srcdir@
srcdir = @srcdir@
top_builddir = @top_builddir@
builddir = @builddir@

include Make.settings

SWIG = @SWIG@

CFLAGS += -fvisibility=hidden -DIGUANAIR_EXPORTS

LIBNAME_OBJ = iguanaIR.o $(COMMON) $(COMMON_COM)

ifdef DARWIN
  LIBNAME = lib$(IGUANAIR).0.$(DYNLIB_EXT)
  LINKARGS = -Wl,-dylib_current_version,0.1.0,-dylib_compatibility_version,0.1.0 -install_name $(DESTDIR)/$(libdir)/$(LIBNAME)
  EXPORTARGS =
else
  LIBNAME = lib$(IGUANAIR).$(DYNLIB_EXT).0
  LINKARGS = -Wl,-soname=$(LIBNAME),--version-script=$(srcdir)/ig.ver
  EXPORTARGS = -Wl,-export-dynamic
endif
LIBNAME_A = lib$(IGUANAIR).a

.PHONY: all
all: $(OSSUPPORT) libs igclient igdaemon drivers utils
igclient igdaemon: $(LIBNAME)

COMMON = support.o compat-unix.o
COMMON_COM = dataPackets.o pipes.o

.PHONY: libs
libs: $(LIBNAME) $(LIBNAME_A)

$(LIBNAME): $(LIBNAME_OBJ)
	$(CC) $(LINKARGS) $(LDFLAGS) $(DYNLIB_FLAGS) $^ -o $@
$(LIBNAME_A): $(LIBNAME_OBJ)
	ar cr $@ $^

.PHONY: drivers utils
drivers utils:
	$(MAKE) -C $@

# Export variables

export CPPFLAGS
export CFLAGS

export DESTDIR

# Support for OS-specific targets.

ifneq ($(OSSUPPORT),)
OSSUPPORT_OBJ = $(OSSUPPORT)/daemon-$(OSSUPPORT).o

OSSUPPORT_CLEAN = $(OSSUPPORT)-clean
OSSUPPORT_DISTCLEAN = $(OSSUPPORT)-distclean
OSSUPPORT_INSTALL = $(OSSUPPORT)-install
OSSUPPORT_UNINSTALL = $(OSSUPPORT)-uninstall

.PHONY: $(OSSUPPORT) $(OSSUPPORT_INSTALL) $(OSSUPPORT_UNINSTALL)
$(OSSUPPORT):
	$(MAKE) -C $@
#$(OSSUPPORT_INSTALL) $(OSSUPPORT_UNINSTALL):
#	$(MAKE) -C $(OSSUPPORT) $(patsubst $(OSSUPPORT)-%,%,$@)
endif

igdaemon: daemon.o \
	  server.o client-interface.o device-interface.o driver.o \
          list.o protocol-versions.o $(OSSUPPORT_OBJ) $(COMMON) $(COMMON_COM)
	$(CC) $(EXPORTARGS) $(CPPFLAGS) $(CFLAGS) -DSUPPORT_EXPORTS \
              $(LDFLAGS) $(DAEMON_LDFLAGS) $^ -lpopt -lpthread -ldl $(LIBNAME) -o $@

$(OSSUPORT_OBJ): $(OSSUPPORT)

server.o: CPPFLAGS += \
	-DDRIVERSDIR='"$(subst ",\",$(subst ','\'',$(subst \,\\,$(libdir))))/$(IGUANAIR)"'

igclient: client.o list.o $(COMMON)
	$(CC) $(LDFLAGS) $^ -lpopt $(LIBNAME) -o $@

%.o: $(srcdir)/%.c Makefile $(top_srcdir)/iguanaIR.h
	$(CC) -c $(CPPFLAGS) $(CFLAGS) $< -o $@

driver.o: $(srcdir)/driver.c Makefile $(top_srcdir)/iguanaIR.h
	$(CC) -c $(CPPFLAGS) $(CFLAGS) -Wno-strict-aliasing $< -o $@

# need a special dependency for config.h
compat-unix.o: compat-unix.c config.h

.PHONY: drivers-clean utils-clean reflasher-clean packaging-clean
$(OSSUPPORT_CLEAN) drivers-clean utils-clean reflasher-clean packaging-clean:
	$(MAKE) -C $(patsubst %-clean,%,$@) clean

.PHONY: drivers-distclean utils-distclean reflasher-distclean packaging-distclean
$(OSSUPPORT_DISTCLEAN) drivers-distclean utils-distclean reflasher-distclean packaging-distclean:
	$(MAKE) -C $(patsubst %-distclean,%,$@) distclean

.PHONY: drivers-install utils-install reflasher-install
$(OSSUPPORT_INSTALL) drivers-install utils-install reflasher-install:
	$(MAKE) -C $(patsubst %-install,%,$@) install

.PHONY: uninstall-utils uninstall-reflasher
$(OSSUPPORT_UNINSTALL) drivers-uninstall utils-uninstall reflasher-uninstall:
	$(MAKE) -C $(patsubst %-uninstall,%,$@) uninstall

# NOTE: I would rather use PYTHON_VERSION, but it doesn't work

ifneq (@PYTHON_CPPFLAGS@,)
all: _iguanaIR.$(PYTHON_DYNMOD_EXT)
install: install-python

.PHONY: install-python
install-python:
	$(INSTALL) -d $(DESTDIR)@PYTHON_SITE_PKG@
	$(INSTALL_DYNLIB) _iguanaIR.$(PYTHON_DYNMOD_EXT) $(DESTDIR)@PYTHON_SITE_PKG@/_iguanaIR.$(PYTHON_DYNMOD_EXT)
	$(INSTALL_DATA) iguanaIR.py $(DESTDIR)@PYTHON_SITE_PKG@/iguanaIR.py

.PHONY: uninstall-python
uninstall-python:
	$(RM) $(DESTDIR)@PYTHON_SITE_PKG@/_iguanaIR.$(PYTHON_DYNMOD_EXT)
	$(RM) $(DESTDIR)@PYTHON_SITE_PKG@/iguanaIR.py

iguanaIR_wrap.c iguanaIR.py: $(srcdir)/iguanaIR.i $(srcdir)/iguanaIR.h Makefile
	$(SWIG) @PYTHON_CPPFLAGS@ -python -outcurrentdir -I$(srcdir) $(<)

iguanaIR_wrap.o: iguanaIR_wrap.c Makefile
#	$(CC) -c $(CPPFLAGS) @PYTHON_CPPFLAGS@ $(CFLAGS) -Wno-strict-aliasing -Wno-unused -Wno-implicit-function-declaration -Wno-long-long $< -o $@
	$(CC) -c $(CPPFLAGS) @PYTHON_CPPFLAGS@ $(CFLAGS) -Wno-missing-field-initializers -Wno-unused -Wno-long-long -Wno-strict-aliasing $< -o $@

_iguanaIR.$(PYTHON_DYNMOD_EXT): iguanaIR_wrap.o
	$(CC) $(LDFLAGS) @PYTHON_LDFLAGS@ $(DYNLIB_FLAGS) $^ $(LIBNAME) -o $@
endif

# change ownership unless we're building an rpm
ifeq ($(RPM_OS)$(DARWIN),)
  SETOWNER=--o iguanair --g iguanair
install: adduser
.PHONY: adduser
adduser:
	/usr/sbin/useradd -u 213 -c "Iguanaworks IR Daemon" -d / -s /sbin/nologin iguanair 2>/dev/null || true

uninstall: deluser
.PHONY: deluser
deluser:
	/usr/sbin/userdel iguanair || true
else
  SETOWNER=
endif

# install a non-versioned symlink
ifneq ($(LIBNAME),libiguanaIR.$(DYNLIB_EXT))
install: install-symlink
.PHONY: install-symlink
install-symlink:
	install -d $(DESTDIR)/$(libdir)
	$(RM) $(DESTDIR)/$(libdir)/lib$(IGUANAIR).$(DYNLIB_EXT)
	ln -s $(LIBNAME) $(DESTDIR)/$(libdir)/lib$(IGUANAIR).$(DYNLIB_EXT)
endif

.PHONY: install
install: all $(OSSUPPORT_INSTALL) drivers-install utils-install reflasher-install
	$(INSTALL) -d $(DESTDIR)/$(bindir)
	$(INSTALL_PROGRAM) igclient $(DESTDIR)/$(bindir)/igclient
	$(INSTALL_PROGRAM) igdaemon $(DESTDIR)/$(bindir)/igdaemon
	$(INSTALL) -d $(DESTDIR)/$(libdir)/iguanaIR
	$(INSTALL_DYNLIB) $(LIBNAME) $(DESTDIR)/$(libdir)/$(LIBNAME)
	$(INSTALL_DATA) $(LIBNAME_A) $(DESTDIR)/$(libdir)/$(LIBNAME_A)
	$(INSTALL) -d $(DESTDIR)$(prefix)/include
	$(INSTALL_DATA) $(srcdir)/iguanaIR.h $(DESTDIR)$(prefix)/include/iguanaIR.h
ifndef DARWIN
	$(INSTALL) -d $(DESTDIR)/etc/init.d/iguanaIR
	$(INSTALL_DATA) $(srcdir)/iguanaIR.init $(DESTDIR)/etc/init.d/iguanaIR
	$(INSTALL) -d $(DESTDIR)/etc/default/iguanaIR
	$(INSTALL_DATA) $(srcdir)/iguanaIR.options $(DESTDIR)/etc/default/iguanaIR
	$(INSTALL_DATA) $(srcdir)/udev/iguanaIR.rules \
	                      $(DESTDIR)/lib/udev/rules.d/80-iguanaIR.rules
	$(INSTALL) -d -m 755 $(SETOWNER) -d $(DESTDIR)/lib/udev/devices/iguanaIR
	$(INSTALL) -d -m 755 $(SETOWNER) -d $(DESTDIR)/dev/iguanaIR
endif

.PHONY: uninstall
uninstall: $(OSSUPPORT_UNINSTALL) drivers-uninstall utils-uninstall reflasher-uninstall
	$(RM) $(DESTDIR)/Library/LaunchDaemons/net.iguanaworks.igdaemon.plist
	/etc/init.d/iguanaIR stop || true
	$(RM) $(DESTDIR)/etc/init.d/iguanaIR
	$(RM) $(DESTDIR)/etc/default/iguanaIR
	$(RM) $(DESTDIR)/etc/udev/rules.d/iguanaIR.rules
	rmdir $(DESTDIR)/lib/udev/devices/iguanaIR 2>/dev/null || true
	rmdir $(DESTDIR)/dev/iguanaIR 2>/dev/null || true
	$(RM) $(DESTDIR)$(bindir)/igclient
	$(RM) $(DESTDIR)$(bindir)/igdaemon
	$(RM) $(DESTDIR)$(libdir)/$(LIBNAME)
	$(RM) $(DESTDIR)$(libdir)/libiguanaIR.$(DYNLIB_EXT)
	$(RM) $(DESTDIR)$(libdir)/$(LIBNAME_A)
	$(RM) $(DESTDIR)$(prefix)/include/iguanaIR.h
	$(RM)r $(DESTDIR)$(libdir)/iguanaIR
	$(RM)r $(DESTDIR)$(libdir)/iguanaIR-reflasher

clean: $(OSSUPPORT_CLEAN) drivers-clean utils-clean reflasher-clean
	$(RM) *iguanaIR.$(PYTHON_DYNMOD_EXT) iguanaIR.py* iguanaIR_wrap.c iguanaIR_wrap.o
	$(RM) *.o $(LIBNAME_A) $(LIBNAME) *iguanaIR.$(DYNLIB_EXT) igdaemon igclient config.log

.PHONY: distclean
distclean: clean $(OSSUPPORT_DISTCLEAN) drivers-distclean utils-distclean reflasher-distclean # packaging-distclean
	$(RM) *~
	$(RM) Makefile Make.settings config.h config.status config.status.* autoconf/stamp-h
	$(RM) darwin/Makefile

.PHONY: cleanest
cleanest: distclean packaging-distclean
	$(RM) -r configure autom4te.cache

.PHONY: package
package: 
	$(MAKE) -C packaging

AUTOCONF=autoconf
ACLOCAL=aclocal
ifeq ($(SYSTEM),freebsd)
    AUTOCONF=autoconf259
    ACLOCAL=aclocal19
endif

.PHONY: dist devel-cleaner
dist: configure
devel-clean: distclean
	$(RM) -r autoconf/autom4te.cache autoconf/aclocal.m4 

# rules to rebuild the configure script
M4S=$(filter-out $(srcdir)/autoconf/aclocal.m4, $(wildcard $(srcdir)/autoconf/*.m4))
autoconf/aclocal.m4: $(M4S)
	cd $(srcdir)/autoconf; $(ACLOCAL)

configure: autoconf/configure.ac autoconf/aclocal.m4
	cd $(srcdir)/autoconf; $(AUTOCONF) -o ../configure configure.ac

config.h.in: autoconf/configure.ac
	cd $(srcdir)/autoconf; autoheader configure.ac; mv config.h.in ..

config.status: configure
	$(SHELL) ./config.status --recheck

Makefile: ./config.status $(srcdir)/Makefile.in $(top_srcdir)/Make.settings.in
	$(SHELL) $<

config.h: autoconf/stamp-h
autoconf/stamp-h: ./config.status config.h.in
	$(SHELL) $<
